{% extends "webnotify/base.html" %}
{% block title %}Sources{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5 text-primary mb-3">Add Source</h2>
        <form id="new-source" method="post" action="/sources/">
          {% csrf_token %}
          <div>
            <label>Name</label>
            <input name="name" placeholder="Fiverr" required />
          </div>
          <div>
            <label>Check URL</label>
            <input name="check_url" placeholder="https://example.com/inbox" required />
          </div>
          <div>
            <label>CSS selector (optional)</label>
            <input name="css_selector" placeholder="#inbox-badge" />
          </div>
          <div>
            <label>Regex text (optional)</label>
            <input name="regex_text" placeholder="message|inbox|new" />
          </div>
          <div>
            <label>Timeout (seconds)</label>
            <input name="timeout" type="number" min="5" max="90" value="20" />
          </div>
          <div>
            <label>User-Agent (optional)</label>
            <input name="user_agent" placeholder="Mozilla/5.0 ..." />
          </div>
          <div>
            <label>Cookies (optional)</label>
            <textarea name="cookies" rows="4" placeholder='
        # Either JSON:
        {"sessionid":"...","csrftoken":"..."}

        # Or lines:
        sessionid=xxxx
        csrftoken=yyyy'></textarea>
          </div>
          <button type="submit">Add source</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6 text-secondary mb-3">Your Sources</h2>
        <div id="sourceList" class="small text-secondary">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
(function(){
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

  async function loadSources(){
    const res = await fetch('/api/sources/', {credentials:'same-origin'});
    const data = await res.json();
    const list = document.getElementById('sourceList');
    if (!data.sources?.length){ list.textContent='No sources yet.'; return; }
    list.innerHTML = data.sources.map(s => `
      <div class="d-flex justify-content-between border-bottom py-1">
        <span>${escapeHtml(s.name)}</span>
        <code class="text-secondary">${escapeHtml(s.check_url)}</code>
      </div>
    `).join('');
  }

  function escapeHtml(t){return (t||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

  document.getElementById('formSource').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = e.target;
    const payload = {
      name: f.name.value,
      check_url: f.check_url.value,
      extra_config: f.extra_config.value || ''
    };
    await fetch('/api/sources/', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': csrf},
      body: JSON.stringify(payload),
      credentials:'same-origin'
    });
    f.reset();
    loadSources();
  });

  loadSources();
})();
</script>
{% endblock %}